<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Singapore Traffic Updates</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container-fluid main-container text-center">
        <h1 class="mb-3">Singapore Traffic Updates</h1>
        <hr class="header-line"> <!-- Styled separator after the header -->

        <div class="expressway-selector">
            <h2>Select an Expressway</h2>

            <div class="d-flex justify-content-center">
                <div class="dropdown mr-3">
                    <button
                        class="btn btn-outline-secondary dropdown-toggle"
                        type="button"
                        data-bs-toggle="dropdown"
                        aria-expanded="false">
                        AYE
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="selectExpressway('4707', 'AYE', 'View from Entrance from Jln Ahmad Ibrahim')">View from Entrance from Jln Ahmad Ibrahim</a></li>
                        <li><a class="dropdown-item" href="#" onclick="selectExpressway('4710', 'AYE', 'View from Towards Pandan Gardens')">View from Towards Pandan Gardens</a></li>
                        <li><a class="dropdown-item" href="#" onclick="selectExpressway('4702', 'AYE', 'View from Keppel Viaduct')">View from Keppel Viaduct</a></li>
                    </ul>
                </div>

                <div class="dropdown mr-3">
                    <button
                        class="btn btn-outline-secondary dropdown-toggle"
                        type="button"
                        data-bs-toggle="dropdown"
                        aria-expanded="false">
                        BKE
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="selectExpressway('2706','BKE', 'View from Woodlands Flyover (Towards Checkpoint)')">View from Woodlands Flyover (Towards Checkpoint)</a></li>
                        <li><a class="dropdown-item" href="#" onclick="selectExpressway('2705', 'BKE', 'View from Dairy Farm Flyover')">View from Dairy Farm Flyover</a></li>
                        <li><a class="dropdown-item" href="#" onclick="selectExpressway('2703', 'BKE', 'View from Chantek Flyover')">View from Chantek Flyover</a></li>
                    </ul>
                </div>

                <div class="dropdown mr-3">
                    <button
                        class="btn btn-outline-secondary dropdown-toggle"
                        type="button"
                        data-bs-toggle="dropdown"
                        aria-expanded="false">
                        CTE
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="selectExpressway('1705', 'CTE', 'View from Ang Mo Kio Ave 5 Flyover')">View from Ang Mo Kio Ave 5 Flyover</a></li>
                        <li><a class="dropdown-item" href="#" onclick="selectExpressway('1702', 'CTE', 'View from Braddell Flyover')">View from Braddell Flyover</a></li>
                        <li><a class="dropdown-item" href="#" onclick="selectExpressway('1704', 'CTE', 'View from Entrance from Chin Swee Road')">View from Entrance from Chin Swee Road</a></li>
                    </ul>
                </div>

                <div class="dropdown mr-3">
                    <button
                        class="btn btn-outline-secondary dropdown-toggle"
                        type="button"
                        data-bs-toggle="dropdown"
                        aria-expanded="false">
                        ECP
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="selectExpressway('3798', 'ECP', 'View from Benjamin Sheares Bridge')">View from Benjamin Sheares Bridge</a></li>
                        <li><a class="dropdown-item" href="#" onclick="selectExpressway('3795', 'ECP', 'View from Marine Parade Flyover')">View from Marine Parade Flyover</a></li>
                        <li><a class="dropdown-item" href="#" onclick="selectExpressway('3704', 'ECP', 'View from Entrance from MCE')">View from Entrance from MCE</a></li>
                    </ul>
                </div>

                <div class="dropdown mr-3">
                    <button
                        class="btn btn-outline-secondary dropdown-toggle"
                        type="button"
                        data-bs-toggle="dropdown"
                        aria-expanded="false">
                        KJE
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="selectExpressway('8706', 'KJE', 'View from Tengah Flyover')">View from Tengah Flyover</a></li>
                        <li><a class="dropdown-item" href="#" onclick="selectExpressway('8701', 'KJE', 'View from Choa Chu Kang West Flyover')">View from Choa Chu Kang West Flyover</a></li>
                        <li><a class="dropdown-item" href="#" onclick="selectExpressway('8702', 'KJE', 'View from Exit To BKE')">View from Exit To BKE</a></li>
                    </ul>
                </div>

                <div class="dropdown mr-3">
                    <button
                        class="btn btn-outline-secondary dropdown-toggle"
                        type="button"
                        data-bs-toggle="dropdown"
                        aria-expanded="false">
                        PIE
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="selectExpressway('6708', 'PIE', 'View from Nanyang Flyover')">View from Nanyang Flyover</a></li>
                        <li><a class="dropdown-item" href="#" onclick="selectExpressway('6704', 'PIE', 'View from Mount Pleasant')">View from Mount Pleasant</a></li>
                        <li><a class="dropdown-item" href="#" onclick="selectExpressway('6711', 'PIE', 'View from Entrance to PIE from ECP Changi')">View from Entrance to PIE from ECP Changi</a></li>
                    </ul>
                </div>

                <div class="dropdown mr-3">
                    <button
                        class="btn btn-outline-secondary dropdown-toggle"
                        type="button"
                        data-bs-toggle="dropdown"
                        aria-expanded="false">
                        SLE
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="selectExpressway('9703', 'SLE', 'View from SLE(BKE) Exit')">View from SLE(BKE) Exit</a></li>
                        <li><a class="dropdown-item" href="#" onclick="selectExpressway('9706', 'SLE', 'View from Mandai Flyover')">View from Mandai Flyover</a></li>
                        <li><a class="dropdown-item" href="#" onclick="selectExpressway('9702', 'SLE', 'View from Upp Thomson Flyover')">View from Upp Thomson Flyover</a></li>
                    </ul>
                </div>

                <div class="dropdown mr-3">
                    <button
                        class="btn btn-outline-secondary dropdown-toggle"
                        type="button"
                        data-bs-toggle="dropdown"
                        aria-expanded="false">
                        TPE
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="selectExpressway('7794', 'TPE', 'View from TPE(KPE) Exit')">View from TPE(KPE) Exit</a></li>
                        <li><a class="dropdown-item" href="#" onclick="selectExpressway('7793', 'TPE', 'View from Tampines Ave 10 Entrance')">View from Tampines Ave 10 Entrance</a></li>
                        <li><a class="dropdown-item" href="#" onclick="selectExpressway('7791', 'TPE', 'View from Upp Changi Flyover Towards PIE')">View from Upp Changi Flyover Towards PIE</a></li>
                    </ul>
                </div>
            </div>

        <!-- Placeholder for the selected location message -->
        <div id="selected-location" class="text-center mt-3" style="font-size: 1.2em; font-weight: bold;"></div>

        <div class="d-flex justify-content-center button-container">
            <button class="btn btn-primary mr-3" onclick="fetchTrafficImages()">Fetch Traffic Images</button>
            <button class="btn btn-secondary" onclick="clearSelection()">Clear Selection</button>
        </div>

        <div id="loading" style="display: none;">Loading...</div>

        <div id="traffic-result" class="row d-flex justify-content-center mt-4 image-gallery"></div>

        <div id="predicted-images-result" class="mt-4">
            <h3>Predicted Images with Bounding Boxes</h3>
            <div class="row d-flex justify-content-center" id="predicted-images"></div>
            <div id="total-predictions" class="mt-3" style="font-size: 1.2em; font-weight: bold;"></div>

            <!-- Incoming Traffic Section -->
            <div id="incoming-traffic" class="mb-4">
                <div id="incoming-direction" class="mt-3" style="font-size: 1.2em; font-weight: bold;"></div>
                <div id="total-incoming" class="mt-3" style="font-size: 1.2em; font-weight: bold;"></div>
                <div id="incoming-congestion-level" class="mt-3" style="font-size: 1.2em; font-weight: bold;"></div>
            </div>

            <!-- Outgoing Traffic Section -->
            <div id="outgoing-traffic" class="mb-4">
                <div id="outgoing-direction" class="mt-3" style="font-size: 1.2em; font-weight: bold;"></div>
                <div id="total-outgoing" class="mt-3" style="font-size: 1.2em; font-weight: bold;"></div>
                <div id="outgoing-congestion-level" class="mt-3" style="font-size: 1.2em; font-weight: bold;"></div>
            </div>

            <!-- Congestion Levels Legend -->
            <div id="congestion-legend" class="mt-4" style="border: 2px solid #333; padding: 10px; border-radius: 8px; width: fit-content; margin: auto;">
                <h4 style="margin-bottom: 10px;">Congestion Levels Legend</h4>
                <div class="d-flex justify-content-center align-items-center">
                    <div class="p-2 mx-2 d-flex align-items-center" style="background-color: green; color: white; border-radius: 5px; min-width: 80px; text-align: center;">
                        <strong>Light</strong>
                    </div>
                    <span class="mx-1" style="font-weight: bold;">(<20)</span>
                    <div class="p-2 mx-2 d-flex align-items-center" style="background-color: orange; color: white; border-radius: 5px; min-width: 80px; text-align: center;">
                        <strong>Medium</strong>
                    </div>
                    <span class="mx-1" style="font-weight: bold;">(≥20 and ≤50)</span>
                    <div class="p-2 mx-2 d-flex align-items-center" style="background-color: red; color: white; border-radius: 5px; min-width: 80px; text-align: center;">
                        <strong>Heavy</strong>
                    </div>
                    <span class="mx-1" style="font-weight: bold;">(>50)</span>
                </div>
            </div>            
        </div>

        <div id="prediction-result"></div>
    </div>

    <script>
        const cameraDirectionMapping = {
        1705: {
            incoming: "Southbound (towards Central Area)",
            outgoing: "Northbound (towards Ang Mo Kio)"
        },
        1702: {
             incoming: "Southbound (towards Central Area)",
             outgoing: "Northbound (towards Ang Mo Kio)"
        },
        1704: {
             incoming: "Southbound (towards Central Area)",
             outgoing: "Northbound (towards Ang Mo Kio)"
        },
        2706: {
            incoming: "Southbound (towards Bukit Panjang)",
            outgoing: "Northbound (towards Woodlands Checkpoint)"
        },
        2705: {
           incoming: "Northbound (towards Woodlands Checkpoint)",
           outgoing: "Southbound (towards Bukit Panjang)"
        },
        2703: {
           incoming: "Southbound (towards Bukit Panjang)",
           outgoing: "Northbound (towards Woodlands Checkpoint)"
        },
        4707: {
           incoming: "Westbound (towards Tuas)",
           outgoing: "Eastbound (towards Marina South)"
        },
        4710: {
           incoming: "Eastbound (towards Marina South)",
           outgoing: "Westbound (towards Tuas)"
        },
        4702: {
           incoming: "Eastbound (towards Marina South)",
           outgoing: "Westbound (towards Tuas)"
        },
        6708: {
           incoming: "Westbound (towards Tuas)",
           outgoing: "Eastbound (towards Changi)"
        },
        6704: {
           incoming: "Eastbound (towards Changi)",
           outgoing: "Westbound (towards Tuas)"
        },
        6711: {
           incoming: "Eastbound (towards Changi)",
           outgoing: "Westbound (towards Tuas)"
        },
        3798: {
           incoming: "Westbound (towards Marina South)",
           outgoing: "Eastbound (towards Changi)"
        },
        3795: {
           incoming: "Westbound (towards Marina South)",
           outgoing: "Eastbound (towards Changi)"
        },

        3704: {
            incoming: "Eastbound (towards Changi)",
            outgoing: "Westbound (towards Marina South)"
        },

        7794: {
            incoming: "Westbound (towards Seletar)",
            outgoing: "Eastbound (towards Pasir Ris)"
        },
        7793: {
            incoming: "Eastbound (towards Pasir Ris)",
            outgoing: "Westbound (towards Seletar)"
        },
        7791: {
            incoming: "Eastbound (towards Pasir Ris)",
            outgoing: "Westbound (towards Seletar)"
        },
        9703: {
            incoming: "Westbound (towards Marsiling)",
            outgoing: "Eastbound (towards Seletar)"
        },
        9706: {
           incoming: "Eastbound (towards Seletar)",
           outgoing: "Westbound (towards Marsiling)"
        },
        9702: {
            incoming: "Westbound (towards Marsiling)",
            outgoing: "Eastbound (towards Seletar)"
        },
        8706: {
            incoming: "Westbound (towards Tengah)",
            outgoing: "Eastbound (towards Bukit Panjang)"
        },
        8701: {
             incoming: "Eastbound (towards Bukit Panjang)",
             outgoing: "Westbound (towards Tengah)"
        },
        8702: {
             incoming: "Eastbound (towards Bukit Panjang)",
             outgoing: "Westbound (towards Tengah)"
        },


        };
        let selectedCameraId = '';

        function selectExpressway(cameraId, expresswayName, locationName) {
            selectedCameraId = cameraId;

            // Clear all active states (both buttons and dropdown items)
            document.querySelectorAll('.expressway-selector button, .dropdown-menu .dropdown-item').forEach(element => {
                element.classList.remove('active');
            });

            // Highlight the selected button or dropdown item
            const buttonOrItem = document.querySelector(`[onclick="selectExpressway('${cameraId}', ${expresswayName}, '${locationName}')"]`);
            if (buttonOrItem) {
                buttonOrItem.classList.add('active');
            }
            // Update the selected location message
            const selectedLocationElement = document.getElementById('selected-location');
            selectedLocationElement.textContent = `Location chosen: ${expresswayName} - ${locationName}`;
        }


        function fetchTrafficImages() {
            if (!selectedCameraId) {
                alert("Please select an expressway first.");
                return;
            }

            document.getElementById('loading').style.display = 'block';

            fetch(`/download_traffic_images?cameraId=${selectedCameraId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loading').style.display = 'none';

                    if (data.status === "success") {
                        const images = data.data.images;
                        const filteredImages = images.filter(img => img.camera_id === selectedCameraId);

                        if (filteredImages.length > 0) {
                            let htmlContent = '';
                            filteredImages.forEach(image => {
                                htmlContent += `
                                    <div class="col-12 col-md-6 mb-3 d-flex justify-content-center">
                                        <img src="${image.url}" alt="Traffic Image for Camera ${selectedCameraId}" class="img-fluid">
                                    </div>`;
                            });
                            document.getElementById('traffic-result').innerHTML = htmlContent;
                            document.getElementById('predicted-images-result').style.display = 'block';

                            fetch(`/predict/${selectedCameraId}`, { method: 'GET' })
                                .then(response => response.json())
                                .then(predictionData => {
                                    if (predictionData.status === "success") {
                                        displayPredictedImages(predictionData.image_urls);
                                        // Total vehicles
                                        const totalPredictions = predictionData.total_predictions;
                                        const totalIncoming = predictionData.total_incoming;
                                        const totalOutgoing = Math.max(totalPredictions - totalIncoming, 0);

                                        // Incoming and Outgoing Directions
                                        const incomingDirection = predictionData.incoming_direction || "Unknown";
                                        const outgoingDirection = predictionData.outgoing_direction || "Unknown";

                                        // Display the total predictions below the images
                                        const totalPredictionsDiv = document.getElementById('total-predictions');
                                        totalPredictionsDiv.textContent = `Total Number Of Vehicles: ${totalPredictions}`;
                                        totalPredictionsDiv.style.display = 'block';  // Ensure it's visible

                                        const totalIncomingDiv = document.getElementById('total-incoming');
                                        totalIncomingDiv.textContent = `Incoming Vehicles: ${totalIncoming}`;
                                        totalIncomingDiv.style.display = 'block';

                                        // Display the total outgoing vehicles
                                        const totalOutgoingDiv = document.getElementById('total-outgoing');
                                        totalOutgoingDiv.textContent = `Outgoing Vehicles: ${totalOutgoing}`;
                                        totalOutgoingDiv.style.display = 'block';  // Ensure it's visible
                                        // Get directions from the mapping
                                        const directions = cameraDirectionMapping[selectedCameraId] || { incoming: "Unknown", outgoing: "Unknown" };
                                        // Display the directions
                                        document.getElementById('incoming-direction').textContent = `Incoming Direction: ${directions.incoming}`;
                                        document.getElementById('incoming-direction').style.display = 'block';

                                        document.getElementById('outgoing-direction').textContent = `Outgoing Direction: ${directions.outgoing}`;
                                        document.getElementById('outgoing-direction').style.display = 'block';

                                        // Calculate the congestion level for incoming vehicles
                                        let incomingCongestionLevel = "";
                                        if (totalIncoming < 20) {
                                             incomingCongestionLevel = "Light";
                                        } else if (totalIncoming >= 20 && totalIncoming <= 50) {
                                            incomingCongestionLevel = "Medium";
                                        } else if (totalIncoming > 50) {
                                             incomingCongestionLevel = "Heavy";
                                        }

                                        // Calculate the congestion level for outgoing vehicles
                                        let outgoingCongestionLevel = "";
                                        if (totalOutgoing < 20) {
                                            outgoingCongestionLevel = "Light";
                                        } else if (totalOutgoing >= 20 && totalOutgoing <= 50) {
                                            outgoingCongestionLevel = "Medium";
                                        } else if (totalOutgoing > 50) {
                                             outgoingCongestionLevel = "Heavy";
                                        }
                                        // Display the congestion levels
                                        const incomingCongestionDiv = document.getElementById('incoming-congestion-level');
                                        incomingCongestionDiv.textContent = `Incoming Congestion Level: ${incomingCongestionLevel}`;
                                        incomingCongestionDiv.style.display = 'block';  // Ensure it's visible

                                        const outgoingCongestionDiv = document.getElementById('outgoing-congestion-level');
                                        outgoingCongestionDiv.textContent = `Outgoing Congestion Level: ${outgoingCongestionLevel}`;
                                        outgoingCongestionDiv.style.display = 'block';  // Ensure it's visible
                                    } else {
                                        document.getElementById('prediction-result').innerHTML = `Prediction Error: ${predictionData.message}`;
                                    }
                                })
                                .catch(error => {
                                    document.getElementById('prediction-result').innerHTML = `Prediction Error: ${error}`;
                                });
                        } else {
                            document.getElementById('traffic-result').innerHTML = `No images found for Camera ID: ${selectedCameraId}`;
                        }
                    } else {
                        document.getElementById('traffic-result').innerHTML = `Error: ${data.message}`;
                    }
                })
                .catch(error => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('traffic-result').innerHTML = `An error occurred: ${error}`;
                });
        }

        function displayPredictedImages(imageUrls) {
            const predictedImagesContainer = document.getElementById('predicted-images');
            predictedImagesContainer.innerHTML = '';
            document.getElementById('predicted-images-result').style.display = 'block';

            imageUrls.forEach(url => {
                const imgContainer = document.createElement('div');
                imgContainer.classList.add("col-12", "col-md-6", "mb-3", "d-flex", "justify-content-center");

                const img = document.createElement('img');
                img.src = url;
                img.alt = "Predicted Image";
                img.classList.add("img-fluid", "traffic-image");
                imgContainer.appendChild(img);

                predictedImagesContainer.appendChild(imgContainer);
            });
        }

        function clearSelection() {
            selectedCameraId = '';

            // Remove the 'active' state from all buttons and dropdown items
            document.querySelectorAll('.expressway-selector button, .dropdown-menu .dropdown-item').forEach(button => button.classList.remove('active'));

            // Clear the selected location message
            const selectedLocationElement = document.getElementById('selected-location');
            selectedLocationElement.textContent = ''; // Remove the text content

            document.querySelectorAll('.expressway-selector button, .dropdown-menu .dropdown-item').forEach(button => button.classList.remove('active'));
            document.getElementById('traffic-result').innerHTML = '';
            document.getElementById('prediction-result').innerHTML = '';
            document.getElementById('predicted-images-result').style.display = 'none';
        }
    </script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.js" integrity="sha256-DrT5NfxfbHvMHux31Lkhxg42LY6of8TaYyK50jnxRnM=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>


</body>
</html>