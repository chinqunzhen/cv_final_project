<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Singapore Traffic Updates</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container-fluid main-container text-center">
        <h1 class="mb-3">Singapore Traffic Updates</h1>
        <hr class="header-line"> <!-- Styled separator after the header -->

        <div class="expressway-selector">
            <h2>Select an Expressway</h2>
            <button class="btn btn-outline-secondary" onclick="selectExpressway('1703')">AYE</button>
            <button class="btn btn-outline-secondary" onclick="selectExpressway('9706')">BKE</button>
            <button class="btn btn-outline-secondary" onclick="selectExpressway('1705')">CTE</button>
            <button class="btn btn-outline-secondary" onclick="selectExpressway('7794')">KPE</button>
            <button class="btn btn-outline-secondary" onclick="selectExpressway('6714')">KJE</button>
            <button class="btn btn-outline-secondary" onclick="selectExpressway('6710')">PIE</button>
            <button class="btn btn-outline-secondary" onclick="selectExpressway('7796')">SLE</button>
            <button class="btn btn-outline-secondary" onclick="selectExpressway('9702')">TPE</button>
        </div>

        <div class="d-flex justify-content-center button-container">
            <button class="btn btn-primary mr-3" onclick="fetchTrafficImages()">Fetch Traffic Images</button>
            <button class="btn btn-secondary" onclick="clearSelection()">Clear Selection</button>
        </div>
        
        <div id="loading" style="display: none;">Loading...</div>

        <div id="traffic-result" class="row d-flex justify-content-center mt-4 image-gallery"></div>

        <div id="predicted-images-result" class="mt-4">
            <h3>Predicted Images with Bounding Boxes</h3>
            <div class="row d-flex justify-content-center" id="predicted-images"></div>
        </div>

        <div id="prediction-result"></div>
    </div>

    <script>
        let selectedCameraId = '';

        function selectExpressway(cameraId) {
            selectedCameraId = cameraId;
            document.querySelectorAll('.expressway-selector button').forEach(button => button.classList.remove('active'));
            document.querySelector(`[onclick="selectExpressway('${cameraId}')"]`).classList.add('active');
        }

        function fetchTrafficImages() {
            if (!selectedCameraId) {
                alert("Please select an expressway first.");
                return;
            }

            document.getElementById('loading').style.display = 'block';

            fetch(`/download_traffic_images?cameraId=${selectedCameraId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loading').style.display = 'none';

                    if (data.status === "success") {
                        const images = data.data.images;
                        const filteredImages = images.filter(img => img.camera_id === selectedCameraId);

                        if (filteredImages.length > 0) {
                            let htmlContent = '';
                            filteredImages.forEach(image => {
                                htmlContent += `
                                    <div class="col-12 col-md-6 mb-3 d-flex justify-content-center">
                                        <img src="${image.url}" alt="Traffic Image for Camera ${selectedCameraId}" class="img-fluid">
                                    </div>`;
                            });
                            document.getElementById('traffic-result').innerHTML = htmlContent;
                            document.getElementById('predicted-images-result').style.display = 'block';

                            fetch(`/predict/${selectedCameraId}`, { method: 'GET' })
                                .then(response => response.json())
                                .then(predictionData => {
                                    if (predictionData.status === "success") {
                                        displayPredictedImages(predictionData.image_urls);
                                    } else {
                                        document.getElementById('prediction-result').innerHTML = `Prediction Error: ${predictionData.message}`;
                                    }
                                })
                                .catch(error => {
                                    document.getElementById('prediction-result').innerHTML = `Prediction Error: ${error}`;
                                });
                        } else {
                            document.getElementById('traffic-result').innerHTML = `No images found for Camera ID: ${selectedCameraId}`;
                        }
                    } else {
                        document.getElementById('traffic-result').innerHTML = `Error: ${data.message}`;
                    }
                })
                .catch(error => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('traffic-result').innerHTML = `An error occurred: ${error}`;
                });
        }

        function displayPredictedImages(imageUrls) {
            const predictedImagesContainer = document.getElementById('predicted-images');
            predictedImagesContainer.innerHTML = '';
            document.getElementById('predicted-images-result').style.display = 'block';
        
            imageUrls.forEach(url => {
                const imgContainer = document.createElement('div');
                imgContainer.classList.add("col-12", "col-md-6", "mb-3", "d-flex", "justify-content-center");
        
                const img = document.createElement('img');
                img.src = url;
                img.alt = "Predicted Image";
                img.classList.add("img-fluid", "traffic-image");
                imgContainer.appendChild(img);
                
                predictedImagesContainer.appendChild(imgContainer);
            });
        }

        function clearSelection() {
            selectedCameraId = '';
            document.querySelectorAll('.expressway-selector button').forEach(button => button.classList.remove('active'));
            document.getElementById('traffic-result').innerHTML = '';
            document.getElementById('prediction-result').innerHTML = '';
            document.getElementById('predicted-images-result').style.display = 'none';
        }
    </script>
</body>
</html>
